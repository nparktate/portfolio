---
import { getCollection } from 'astro:content';
import Base from "../layouts/Base.astro";
import Hero from "../components/Hero.astro";
import Navigation from "../components/Navigation.astro";
import { marked } from 'marked';

// Get all section content, sorted by order
const sections = await getCollection('sections');
const sortedSections = sections.sort((a, b) => a.data.order - b.data.order);

// Configure marked to only process headings
const renderer = new marked.Renderer();
const originalHeadingRenderer = renderer.heading;
renderer.heading = function(text, level) {
  return originalHeadingRenderer.call(this, text, level);
};

// Process only the headings in Markdown
marked.setOptions({
  renderer: renderer,
  headerIds: false,
});

// Process each section's content
sortedSections.forEach(section => {
  // Find Markdown headings and convert only those
  let processedBody = section.body;
  
  // Process ## headings (h2) but preserve HTML
  processedBody = processedBody.replace(/^## (.*)$/gm, '<h2>$1</h2>');
  
  // Process ### headings (h3) but preserve HTML
  processedBody = processedBody.replace(/^### (.*)$/gm, '<h3>$1</h3>');
  
  // Assign the processed content back
  section.processedBody = processedBody;
});
---

<Base>
    <!-- Navigation -->
    <Navigation sections={sortedSections} />
    
    <!-- Hero section -->
    <Hero />

    <!-- Content sections -->
    <main class="content-sections">
        {sortedSections.map((section, index) => (
            <section 
                id={section.slug} 
                class={`py-32 px-6 js-fade timeline-item ${section.slug === "02_experience" ? "timeline-section" : ""} ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}
            >
                <div class="max-w-5xl mx-auto">
                    <header class="mb-16">
                        <h2 class="text-4xl md:text-5xl lg:text-6xl font-serif font-bold relative inline-block">
                            {section.data.title}
                            <span class="absolute -bottom-3 left-0 w-full h-[3px] bg-primary-500 transform origin-left"></span>
                        </h2>
                    </header>
                    
                    <div class="prose prose-xl prose-headings:font-serif prose-headings:font-bold prose-headings:tracking-tight 
                        prose-p:text-gray-700 prose-a:text-primary-600 prose-a:no-underline hover:prose-a:text-primary-800 
                        hover:prose-a:underline prose-img:rounded-lg prose-strong:text-gray-900 prose-strong:font-semibold max-w-none">
                        <Fragment set:html={section.processedBody || section.body} />
                    </div>
                </div>
            </section>
        ))}
    </main>
    
    <!-- Remove local styles since they're now in Base.astro -->
</Base>